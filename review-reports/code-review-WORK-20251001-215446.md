# Code Review Report - ffl-playoffs-api
**Work ID**: WORK-20251001-215446-2873238
**Date**: 2025-10-01
**Reviewer**: Project Structure Engineer
**Scope**: ffl-playoffs-api/src/main/java/

---

## Executive Summary

**Status**: ‚ùå **CRITICAL - WRONG DOMAIN MODEL IMPLEMENTED**

The codebase has implemented the **WRONG game model**. The code implements a **team-based selection model** (players select entire NFL teams) instead of the **roster-based fantasy football model** (players build rosters with individual NFL players by position) as specified in requirements.md and feature files.

### Impact
- **Implementation does not match requirements** ‚ùå
- **Feature files cannot be implemented with current domain model** ‚ùå
- **Significant refactoring required** ‚ö†Ô∏è

---

## Critical Issue: Wrong Domain Model ‚ùå

### The Problem

The codebase implements **TWO INCOMPATIBLE** game models:

#### Model 1: Team-Based (IMPLEMENTED - INCORRECT)
Players select entire NFL **teams** for each week:
- `TeamSelection.java` (domain/model)
- `TeamSelectionRepository.java` (domain/port)
- `SelectTeamUseCase.java` (application/usecase)
- `POST /api/v1/players/{playerId}/teams` endpoint

#### Model 2: Roster-Based (PARTIAL - CORRECT)
Players build rosters with individual NFL **players** by position:
- `Roster.java` (domain/model) ‚úì EXISTS
- `RosterSlot.java` (domain/model) ‚úì EXISTS
- `NFLPlayer.java` (domain/model) ‚úì EXISTS
- **NO RosterRepository** ‚ùå MISSING
- **NO Use Cases** ‚ùå MISSING
- **NO REST endpoints** ‚ùå MISSING

### Requirements.md States (Section 2)

> "**Individual NFL Player Selection by Position**"
> "**IMPORTANT**: League players build rosters by selecting individual NFL players (e.g., 'Patrick Mahomes', 'Christian McCaffrey')"
> "This is traditional fantasy football roster management with position-based selection"
> "Roster structure configured by admin (e.g., 1 QB, 2 RB, 2 WR, 1 TE, 1 FLEX, 1 K, 1 DEF, 1 Superflex)"

### Feature Files Confirm Roster Model

- `roster-management.feature` (314 lines) - ONE-TIME DRAFT with NFL players ‚úì
- `player-roster-selection.feature` (485 lines) - Position-based roster building ‚úì
- `player-selection.feature` (290 lines) - Search and select individual NFL players ‚úì
- `roster-lock.feature` (169 lines) - Roster lock after first game starts ‚úì

**NO team-based selection feature files exist.**

### Evidence from Code

#### Player.java (WRONG MODEL)
```java
// Lines 19, 45, 52
private List<TeamSelection> teamSelections;  // ‚ùå Should be Roster

public void makeTeamSelection(TeamSelection selection) {  // ‚ùå Wrong method
    this.teamSelections.add(selection);
}
```

#### TeamSelection.java (SHOULD NOT EXIST)
```java
// This entire class is wrong model
public class TeamSelection {
    private String nflTeamCode;    // ‚ùå Selecting teams, not players
    private String nflTeamName;    // ‚ùå Should be NFLPlayer reference
    private Integer week;          // ‚ùå No weeks in roster model
}
```

#### PlayerController.java (WRONG ENDPOINTS)
```java
// Lines 32-39
@PostMapping("/{playerId}/teams")  // ‚ùå Wrong endpoint
public ResponseEntity<TeamSelectionDTO> selectTeam(  // ‚ùå Wrong method
    @PathVariable String playerId,
    @Valid @RequestBody TeamSelectionDTO teamSelectionDTO) {
    TeamSelectionDTO selection = selectTeamUseCase.execute(teamSelectionDTO);  // ‚ùå Wrong use case
    return ResponseEntity.status(HttpStatus.CREATED).body(selection);
}
```

#### What SHOULD Exist (But Doesn't)
```java
// domain/port/RosterRepository.java (MISSING)
public interface RosterRepository {
    Roster save(Roster roster);
    Optional<Roster> findByLeaguePlayerId(UUID leaguePlayerId);
    void lockRoster(UUID rosterId, LocalDateTime lockTime);
}

// application/usecase/AssignRosterSlotUseCase.java (MISSING)
public class AssignRosterSlotUseCase {
    public void execute(UUID rosterId, UUID slotId, Long nflPlayerId) {
        // Assign NFL player to roster slot
    }
}

// REST endpoint (MISSING)
@PostMapping("/leagues/{leagueId}/roster/slots/{slotId}/assign")
public ResponseEntity<RosterSlotDTO> assignPlayer(...) {
    // Assign individual NFL player to roster slot
}
```

---

## File-by-File Analysis

### ‚úÖ FflPlayoffsApiApplication.java
**Status**: CORRECT

```java
@SpringBootApplication
public class FflPlayoffsApiApplication {
    public static void main(String[] args) {
        SpringApplication.run(FflPlayoffsApiApplication.class, args);
    }
}
```

**Assessment**:
- Standard Spring Boot main class ‚úì
- No issues ‚úì
- Clean and simple ‚úì

---

### ‚úÖ Game.java (Mostly Correct)
**Status**: GOOD - Configuration Lock Logic Correct

**Strengths**:
- ‚úÖ Configuration lock implementation (lines 84-131)
- ‚úÖ `validateConfigurationMutable(LocalDateTime currentTime)` method
- ‚úÖ `ConfigurationLockedException` custom exception
- ‚úÖ Setters with validation guards (lines 177-277)
- ‚úÖ `firstGameStartTime` tracking
- ‚úÖ No framework dependencies (pure domain)

**Issues**:
- ‚ö†Ô∏è Line 27: `List<Player> players;` - Should this be `List<LeaguePlayer>`? Requirements mention LeaguePlayer as junction table
- ‚ö†Ô∏è Missing `RosterConfiguration` field (requirements: Game has rosterConfiguration)
- ‚ö†Ô∏è Missing validation for `startingWeek + numberOfWeeks - 1 ‚â§ 22`

**Recommendation**:
```java
// Add missing fields and validation
private RosterConfiguration rosterConfiguration;
private Integer maxPlayers;
private Boolean isPublic;

public void setStartingWeek(Integer startingWeek, LocalDateTime currentTime) {
    validateConfigurationMutable(currentTime);
    validateWeekRange(startingWeek, this.numberOfWeeks);  // ADD THIS
    this.startingWeek = startingWeek;
}

private void validateWeekRange(Integer startingWeek, Integer numberOfWeeks) {
    if (startingWeek + numberOfWeeks - 1 > 22) {
        throw new InvalidWeekRangeException(
            "startingWeek + numberOfWeeks - 1 must be ‚â§ 22"
        );
    }
}
```

---

### ‚ùå Player.java (WRONG MODEL)
**Status**: CRITICAL - Uses Wrong Domain Model

**Issues**:
1. Line 19: `List<TeamSelection> teamSelections;`
   - ‚ùå Should be: `Roster roster;` (one roster per player per league)

2. Line 45: `makeTeamSelection(TeamSelection selection)`
   - ‚ùå Should NOT exist

3. Line 63-72: `hasSelectedTeamForWeek()`, `getSelectionForWeek()`
   - ‚ùå Wrong model - no weekly team selections

4. Missing roster reference:
   - ‚ùå Should have: `private Roster roster;`

**Correct Implementation**:
```java
public class Player {
    private UUID id;
    private UUID gameId;
    private String name;
    private String email;
    private PlayerStatus status;
    private LocalDateTime joinedAt;
    private Roster roster;  // ‚úì ONE roster per player
    private boolean isEliminated;

    // No team selection methods
    // Roster is managed through RosterRepository
}
```

---

### ‚ùå TeamSelection.java (SHOULD BE DELETED)
**Status**: CRITICAL - Entire Class is Wrong Model

**The Problem**: This class represents the OLD game model that is **NOT in requirements**.

**Evidence**:
- No `team-selection.feature` file exists
- No mention of "team selection" in requirements.md Section 2
- Feature files show roster-based model

**Action Required**:
```bash
# DELETE THIS FILE
rm domain/model/TeamSelection.java
```

---

### ‚úÖ Roster.java (CORRECT but UNUSED)
**Status**: GOOD - Correct Implementation, But Not Integrated

**Strengths**:
- ‚úÖ Correct aggregate root for roster-based model
- ‚úÖ `assignPlayerToSlot()` method (line 52)
- ‚úÖ `validateNotLocked()` guard (line 139)
- ‚úÖ Duplicate player validation (line 56)
- ‚úÖ Position eligibility via RosterSlot
- ‚úÖ `RosterLockedException` custom exception
- ‚úÖ No framework dependencies

**Issues**:
- ‚ùå No RosterRepository port interface
- ‚ùå No use cases using Roster
- ‚ùå No REST endpoints for roster operations
- ‚ö†Ô∏è Line 143: Deadline check should also check first game start time (like Game.java does)

**Recommendation**:
```java
// Update validateNotLocked() to match Game lock logic
private void validateNotLocked() {
    if (isLocked) {
        throw new RosterLockedException("Roster is locked - no changes allowed");
    }
    // Add first game check similar to Game.isConfigurationLocked()
    if (firstGameStartTime != null && LocalDateTime.now().isAfter(firstGameStartTime)) {
        throw new RosterLockedException("Roster locked - first game has started");
    }
}
```

---

### ‚úÖ NFLPlayer.java (CORRECT but UNUSED)
**Status**: GOOD - Well Designed

**Strengths**:
- ‚úÖ Comprehensive stat fields for all positions
- ‚úÖ Position-specific stats (QB, RB/WR/TE, K, DEF)
- ‚úÖ Status tracking (ACTIVE, INJURED, BYE)
- ‚úÖ Business methods: `isActive()`, `isInjured()`, `isOnBye()`
- ‚úÖ External player ID for API integration
- ‚úÖ No framework dependencies

**Minor Issues**:
- ‚ö†Ô∏è Defensive stats on NFLPlayer (should be on separate DefensiveStats entity per requirements)
- ‚ö†Ô∏è Season stats stored on player (should be in PlayerStats entity per requirements)

**Recommendation**:
- Keep this class but move stats to separate entities as per requirements.md data model

---

### ‚ùå TeamSelectionRepository.java (SHOULD BE DELETED)
**Status**: CRITICAL - Port Interface for Wrong Model

**Action Required**:
```bash
# DELETE THIS FILE
rm domain/port/TeamSelectionRepository.java
```

**Replace With**:
```java
// domain/port/RosterRepository.java (CREATE THIS)
public interface RosterRepository {
    Roster save(Roster roster);
    Optional<Roster> findById(UUID rosterId);
    Optional<Roster> findByLeaguePlayerId(UUID leaguePlayerId);
    void lockRoster(UUID rosterId, LocalDateTime lockTime);
    List<Roster> findByGameId(UUID gameId);
    void delete(UUID rosterId);
}
```

---

### ‚ùå PlayerController.java (WRONG ENDPOINTS)
**Status**: CRITICAL - Implements Wrong Model APIs

**Issues**:
1. Line 23: `SelectTeamUseCase` - wrong use case
2. Line 32-39: `selectTeam()` endpoint - wrong model
3. Line 48-53: `getPlayerTeamSelections()` - wrong model

**Action Required**:
```bash
# DELETE OR REFACTOR
# Replace with roster endpoints
```

**Correct Endpoints**:
```java
@RestController
@RequestMapping("/api/v1/leagues/{leagueId}/roster")
public class RosterController {

    @GetMapping
    public ResponseEntity<RosterDTO> getMyRoster(@PathVariable UUID leagueId) {
        // Get roster for authenticated player
    }

    @PostMapping("/slots/{slotId}/assign")
    public ResponseEntity<RosterSlotDTO> assignPlayer(
        @PathVariable UUID leagueId,
        @PathVariable UUID slotId,
        @RequestBody AssignPlayerRequest request) {
        // Assign NFL player to roster slot
    }

    @DeleteMapping("/slots/{slotId}")
    public ResponseEntity<Void> removePlayer(
        @PathVariable UUID leagueId,
        @PathVariable UUID slotId) {
        // Remove player from roster slot
    }
}
```

---

## Architecture Compliance

### ‚úÖ Hexagonal Architecture Structure
**Status**: GOOD - Correct Package Organization

```
src/main/java/com/ffl/playoffs/
‚îú‚îÄ‚îÄ domain/           ‚úì Core business logic
‚îÇ   ‚îú‚îÄ‚îÄ model/       ‚úì Entities and value objects
‚îÇ   ‚îú‚îÄ‚îÄ port/        ‚úì Repository interfaces
‚îÇ   ‚îú‚îÄ‚îÄ service/     ‚úì Domain services
‚îÇ   ‚îî‚îÄ‚îÄ event/       ‚úì Domain events
‚îú‚îÄ‚îÄ application/      ‚úì Use cases and DTOs
‚îÇ   ‚îú‚îÄ‚îÄ usecase/     ‚úì Application services
‚îÇ   ‚îú‚îÄ‚îÄ dto/         ‚úì Data transfer objects
‚îÇ   ‚îî‚îÄ‚îÄ service/     ‚úì Application services
‚îî‚îÄ‚îÄ infrastructure/   ‚úì Adapters
    ‚îú‚îÄ‚îÄ adapter/     ‚úì External implementations
    ‚îÇ   ‚îú‚îÄ‚îÄ rest/    ‚úì HTTP controllers
    ‚îÇ   ‚îî‚îÄ‚îÄ persistence/  ‚úì Database adapters
    ‚îî‚îÄ‚îÄ config/      ‚úì Spring configuration
```

**Assessment**: Package structure follows hexagonal architecture correctly ‚úì

### ‚ùå Domain Model Issues

**Current State**:
- Domain has BOTH models (TeamSelection + Roster)
- Only TeamSelection is connected to ports/use cases/controllers
- Roster model is orphaned (exists but unused)

**Required State**:
- DELETE TeamSelection model entirely
- CREATE RosterRepository port
- CREATE roster use cases
- CREATE roster REST endpoints
- UPDATE Player to reference Roster

---

## Dependency Analysis

### ‚úÖ Domain Layer - No Framework Dependencies
**Status**: EXCELLENT

Checked all domain model files:
- ‚úÖ Game.java - Pure Java, no Spring/MongoDB
- ‚úÖ Player.java - Pure Java
- ‚úÖ Roster.java - Pure Java
- ‚úÖ NFLPlayer.java - Pure Java
- ‚úÖ TeamSelection.java - Pure Java (but wrong model)
- ‚úÖ All port interfaces - No framework deps

**Conclusion**: Domain layer correctly has NO external dependencies ‚úì

### ‚ö†Ô∏è Infrastructure Layer - Incomplete

**Current State**:
- Only GameMongoRepository implemented
- No RosterMongoRepository
- No NFLPlayerMongoRepository
- Controllers use wrong model

**Required**:
- Implement all MongoDB repositories
- Implement roster endpoints
- Remove team selection endpoints

---

## Missing Components

### Critical (Must Implement)

1. **RosterRepository Port** ‚ùå
   - Location: `domain/port/RosterRepository.java`
   - Status: DOES NOT EXIST

2. **Roster Use Cases** ‚ùå
   - `AssignRosterSlotUseCase` - MISSING
   - `RemoveRosterSlotUseCase` - MISSING
   - `GetRosterUseCase` - MISSING
   - `LockRosterUseCase` - MISSING

3. **Roster REST Controller** ‚ùå
   - `RosterController.java` - MISSING
   - All roster endpoints - MISSING

4. **NFLPlayer Repository** ‚ùå
   - `domain/port/NFLPlayerRepository.java` - MISSING
   - MongoDB implementation - MISSING

5. **RosterSlot Repository** ‚ùå
   - May need persistence for roster slots

### Should NOT Exist (Must Delete)

1. **TeamSelection.java** ‚ùå DELETE
2. **TeamSelectionRepository.java** ‚ùå DELETE
3. **SelectTeamUseCase.java** ‚ùå DELETE (if exists)
4. **Team selection endpoints** ‚ùå DELETE from PlayerController

---

## Code Quality Assessment

### Strengths ‚úÖ

1. **Clean Architecture**: Proper hexagonal architecture structure
2. **Domain Purity**: No framework dependencies in domain layer
3. **Configuration Lock Logic**: Well implemented in Game.java
4. **Roster Domain Model**: Well designed (just not used)
5. **Exception Handling**: Custom domain exceptions
6. **Documentation**: Javadoc comments on classes

### Weaknesses ‚ùå

1. **Wrong Domain Model**: Implements team-based instead of roster-based
2. **Orphaned Code**: Roster model exists but unused
3. **Missing Core Features**: No roster operations implemented
4. **Inconsistent Implementation**: Two incompatible models coexist

---

## Recommendations

### Priority 1: CRITICAL (Block Development)

1. **DELETE Team-Based Model** üî•
   ```bash
   rm domain/model/TeamSelection.java
   rm domain/port/TeamSelectionRepository.java
   # Remove SelectTeamUseCase if exists
   # Remove team endpoints from PlayerController
   ```

2. **CREATE Roster Infrastructure** üî•
   - `domain/port/RosterRepository.java`
   - `domain/port/NFLPlayerRepository.java`
   - `application/usecase/AssignRosterSlotUseCase.java`
   - `application/usecase/GetRosterUseCase.java`
   - `infrastructure/adapter/rest/RosterController.java`

3. **UPDATE Player.java** üî•
   ```java
   // Remove teamSelections
   // Add roster reference
   private Roster roster;
   ```

### Priority 2: Enhancement

4. **Add Missing Validations**
   - Week range validation in Game.java
   - Roster deadline vs first game check in Roster.java

5. **Implement Data Model Entities**
   - PlayerStats entity (per-game stats)
   - DefensiveStats entity (team defense stats)
   - NFLTeam entity
   - Week entity with NFL week mapping

6. **Complete MongoDB Implementation**
   - RosterMongoRepository
   - NFLPlayerMongoRepository
   - Document entities and mappers

---

## Comparison with Requirements

| Requirement | Implementation | Status |
|-------------|---------------|--------|
| Individual NFL player selection | TeamSelection (wrong) | ‚ùå |
| Roster with position slots (QB, RB, WR, etc.) | Roster.java exists | ‚ö†Ô∏è Exists but unused |
| ONE-TIME DRAFT model | Not implemented | ‚ùå |
| Roster lock after first game | Roster.lockRoster() exists | ‚ö†Ô∏è Exists but not used |
| No waiver wire, no trades | N/A | ‚úì Not implemented (correct) |
| Configuration lock | Game.java implemented | ‚úÖ CORRECT |
| Week range validation | Missing | ‚ùå |
| RosterConfiguration | Missing from Game | ‚ùå |

---

## Consistency with Feature Files

| Feature File | Implementation | Match |
|-------------|----------------|-------|
| roster-management.feature | No roster endpoints | ‚ùå |
| player-roster-selection.feature | No roster selection logic | ‚ùå |
| player-selection.feature | No NFLPlayer search | ‚ùå |
| roster-lock.feature | Roster.lockRoster() exists | ‚ö†Ô∏è Partial |
| league-configuration.feature | Game config lock works | ‚úÖ |

**Overall Match**: 20% ‚ùå

---

## Risk Assessment

### High Risk üî¥

1. **Wrong Model Implemented**: Entire domain model is incorrect
   - **Impact**: Cannot implement feature files without complete refactor
   - **Effort**: 2-3 weeks to refactor

2. **No Core Functionality**: Roster operations don't exist
   - **Impact**: Cannot build rosters, core game feature missing
   - **Effort**: 1-2 weeks to implement

### Medium Risk üü°

3. **Missing Data Integration**: No NFL data provider implementation
   - **Impact**: Cannot fetch real NFL player data
   - **Effort**: 1 week

4. **Incomplete Persistence**: Only Game repository exists
   - **Impact**: Cannot persist rosters or players
   - **Effort**: 3-5 days

---

## Action Plan

### Phase 1: Delete Wrong Model (1 day)
- [ ] Delete TeamSelection.java
- [ ] Delete TeamSelectionRepository.java
- [ ] Delete SelectTeamUseCase if exists
- [ ] Remove team endpoints from controllers
- [ ] Update Player.java to remove teamSelections

### Phase 2: Create Roster Ports (2 days)
- [ ] Create RosterRepository.java
- [ ] Create NFLPlayerRepository.java
- [ ] Create LeaguePlayerRepository.java

### Phase 3: Implement Roster Use Cases (3-5 days)
- [ ] AssignRosterSlotUseCase
- [ ] RemoveRosterSlotUseCase
- [ ] GetRosterUseCase
- [ ] LockRosterUseCase
- [ ] GetRosterConfigurationUseCase

### Phase 4: Implement REST Endpoints (2-3 days)
- [ ] RosterController with all endpoints
- [ ] NFLPlayerController for player search
- [ ] Update API to match docs/API.md roster endpoints

### Phase 5: Implement Persistence (3-5 days)
- [ ] RosterMongoRepository
- [ ] NFLPlayerMongoRepository
- [ ] Document entities and mappers
- [ ] MongoDB indexes

### Phase 6: Testing (5-7 days)
- [ ] Unit tests for domain model
- [ ] Integration tests for repositories
- [ ] API endpoint tests
- [ ] BDD tests from feature files

**Total Estimated Effort**: 16-23 days (3-4 weeks)

---

## Conclusion

The codebase shows good architectural structure and clean code practices, but has a **critical flaw**: it implements the **wrong domain model**.

**Current State**:
- ‚ùå Team-based selection model implemented (wrong)
- ‚ö†Ô∏è Roster-based model partially exists (correct but unused)
- ‚ùå Cannot implement feature files without major refactor

**Required Action**:
1. **DELETE** all team-based model code
2. **COMPLETE** roster-based model implementation
3. **IMPLEMENT** missing ports, use cases, and endpoints

**Status**: **DO NOT MERGE** - Critical refactoring required

---

## References

- ‚úÖ requirements.md - Specifies roster-based model
- ‚úÖ features/roster-management.feature - Roster-based scenarios
- ‚úÖ features/player-roster-selection.feature - Position-based selection
- ‚ùå Code implements team-based model (wrong)

---

**Reviewer**: Project Structure Engineer
**Date**: 2025-10-01
**Status**: CRITICAL ISSUES FOUND - REFACTORING REQUIRED
